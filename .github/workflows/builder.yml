name: Builder CI

on:
  push:
  pull_request:
  merge_group:

env:
  CARGO_TERM_COLOR: always
  # Zero out OTEL env vars to prevent local environment interference in tests
  OTEL_EXPORTER_OTLP_ENDPOINT: ""
  OTEL_EXPORTER_OTLP_HEADERS: ""
  OTEL_SDK_DISABLED: "true"

permissions:
  contents: read

jobs:
  build-builder:
    name: Build Builder Crates
    runs-on: ubuntu-24.04
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@002fdce3c6a235733a90a27c80493a3241e56863 # v2.12.1
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install native dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libsqlite3-dev \
            clang \
            libclang-dev \
            llvm \
            build-essential \
            pkg-config \
            libtss2-dev

      - uses: dtolnay/rust-toolchain@4305c38b25d97ef35a8ad1f985ccf2d2242004f2 # stable
        with:
          components: clippy

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
        with:
          cache-on-failure: true
          add-rust-environment-hash-key: "false"
          key: builder-stable-${{ hashFiles('Cargo.lock') }}

      - name: Install just
        uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3

      - name: Build builder crates
        run: just build-builder

  test-builder:
    name: Test Builder Crates
    runs-on: ubuntu-24.04
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@002fdce3c6a235733a90a27c80493a3241e56863 # v2.12.1
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install native dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libsqlite3-dev \
            clang \
            libclang-dev \
            llvm \
            build-essential \
            pkg-config \
            libtss2-dev

      - uses: dtolnay/rust-toolchain@4305c38b25d97ef35a8ad1f985ccf2d2242004f2 # stable

      - uses: rui314/setup-mold@725a8794d15fc7563f59595bd9556495c0564878 # v1

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
        with:
          cache-on-failure: true
          add-rust-environment-hash-key: "false"
          key: builder-stable-${{ hashFiles('Cargo.lock') }}

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@50d5a8956f2e319df19e6b57539d7e2acb9f8c1e # v1.5.0
        with:
          version: stable

      - name: Install just
        uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3

      - name: Run builder tests
        run: just test-builder
        env:
          TESTS_TEMP_DIR: ${{ github.workspace }}

  clippy-builder:
    name: Clippy Builder Crates
    runs-on: ubuntu-24.04
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@002fdce3c6a235733a90a27c80493a3241e56863 # v2.12.1
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install native dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libsqlite3-dev \
            clang \
            libclang-dev \
            llvm \
            build-essential \
            pkg-config \
            libtss2-dev

      - uses: dtolnay/rust-toolchain@0c3131df9e5407c0c36352032d04af846dbe0fb7 # nightly
        with:
          components: clippy

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
        with:
          cache-on-failure: true
          add-rust-environment-hash-key: "false"
          key: builder-nightly-${{ hashFiles('Cargo.lock') }}

      - name: Install just
        uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3

      - name: Run clippy on builder crates
        run: just check-clippy-builder
