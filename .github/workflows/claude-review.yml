name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]

concurrency:
  group: claude-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  # This allows posting comments and reviews
  # It does not allow pushing any commits or modifying any files in the repo
  pull-requests: write

jobs:
  review:
    name: Review PR
    # Note: This job runs on the BaseRunnerGroup to be able to access LLM Gateway
    # It will not work on other runners
    runs-on:
      group: BaseRunnerGroup
    steps:
      - name: Harden the runner (Block unauthorized outbound calls)
        uses: step-security/harden-runner@002fdce3c6a235733a90a27c80493a3241e56863 # v2.12.1
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            bun.sh:443
            github.com:443
            objects.githubusercontent.com:443
            registry.npmjs.org:443
            release-assets.githubusercontent.com:443
            ${{ vars.LLM_GATEWAY_HOSTNAME }}:443

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Run Claude Code
        id: claude-review
        uses: anthropics/claude-code-action@1b8ee3b94104046d71fde52ec3557651ad8c0d71 # v1.0.29
        env:
          ANTHROPIC_BASE_URL: https://${{ vars.LLM_GATEWAY_HOSTNAME }}

        with:
          anthropic_api_key: ${{ secrets.LLM_GATEWAY_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          # When track_progress is enabled:
          # - Creates a tracking comment with progress checkboxes
          # - Includes all PR context (comments, attachments, images)
          # - Updates progress as the review proceeds
          # - Marks as completed when done
          track_progress: false

          # review instructions
          prompt: |
            You are reviewing a Pull Request for Base Reth Node — a Rust Ethereum L2 node built on Reth.

            CODEBASE:
            - 4 core crate groups: crates/{client, builder, consensus, shared}
            - devnet/: system and E2E test infrastructure for Base node
            - Error handling: thiserror enums with From impls
            - Async: tokio, async-trait, arc-swap for lock-free config
            - CI already enforces: clippy (52 rules, -D warnings), rustfmt (2024 edition), cargo-deny, cargo-udeps

            REVIEW GUIDELINES:
            - Review like a senior Rust engineer on the team
            - Focus on correctness, safety, and idiomatic Rust
            - DO NOT comment on formatting or style — clippy and rustfmt handle that
            - DO NOT post praise, "looks good", or filler comments. If everything looks fine, post nothing
            - Use inline comments for specific code feedback via mcp__github_inline_comment__create_inline_comment
            - Post one summary comment at the end with your overall assessment (if you have findings)

            WHAT TO LOOK FOR:
            - Error handling: .unwrap()/.expect() in non-test code, discarded error context (.map_err(|_| ...)), missing From impls
            - Memory & performance: unnecessary .clone() on large types in hot paths, unbounded collections from external input
            - Concurrency: locks held across .await, channel misuse (no backpressure, unhandled closed channels), cancellation safety in tokio::select!
            - Safety: unsafe without // SAFETY comments, unchecked arithmetic on financial/gas values, HashMap in determinism-sensitive code
            - API design: missing #[must_use] on Result-returning public methods, breaking changes to public interfaces
            - Architecture: dependency direction violations (shared depending on client/builder), tight coupling between crate layers
            - Rust idioms: &String instead of &str, &Vec<T> instead of &[T], manual implementations of standard traits, needless lifetime annotations

            COMMENT MANAGEMENT:
            Before posting your review summary, clean up previous summary comments from earlier runs:
            1. Delete your previous summary comments by running: gh pr comment ${{ github.event.pull_request.number }} --delete-last --yes
            2. Repeat step 1 until it returns an error (no more comments to delete)
            3. Then post your new summary using: gh pr comment ${{ github.event.pull_request.number }} --body "<!-- CLAUDE_REVIEW_SUMMARY -->\n\n<your summary>"
            Note: --delete-last only deletes your own top-level comments, not inline review comments or other users' comments.

          claude_args: |
            --model claude-opus-4-6-default
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment ${{ github.event.pull_request.number }} --body:*),Bash(gh pr comment ${{ github.event.pull_request.number }} --edit-last --body:*),Bash(gh pr comment ${{ github.event.pull_request.number }} --delete-last:*),Bash(gh pr diff:*),Bash(gh pr view:*)"
