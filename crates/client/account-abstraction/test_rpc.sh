#!/bin/bash
# Test Account Abstraction RPC endpoints

set -e
# builder playground = http://localhost:8549
RPC_URL="${RPC_URL:-http://localhost:8549}"

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

echo -e "${BLUE}Testing Account Abstraction RPC endpoints at $RPC_URL${NC}"
echo ""

# Helper function to make RPC calls and validate response
rpc_call() {
    local response
    response=$(curl -sf -X POST "$RPC_URL" \
        -H "Content-Type: application/json" \
        -d "$1" 2>&1) || {
        echo -e "${RED}‚úó Failed to connect to $RPC_URL${NC}"
        echo -e "${RED}  Make sure the node is running with AA enabled:${NC}"
        echo -e "${RED}  just run-node-aa${NC}"
        exit 1
    }
    echo "$response" | jq .
    
    # Check for JSON-RPC error
    if echo "$response" | jq -e '.error' > /dev/null 2>&1; then
        echo -e "${RED}‚úó RPC returned error${NC}"
        return 1
    fi
    return 0
}

# Check connection first
echo -e "${YELLOW}Checking connection to $RPC_URL...${NC}"
if ! curl -sf -X POST "$RPC_URL" -H "Content-Type: application/json" -d '{"jsonrpc":"2.0","id":0,"method":"eth_chainId","params":[]}' > /dev/null 2>&1; then
    echo -e "${RED}‚úó Cannot connect to $RPC_URL${NC}"
    echo -e "${RED}  Make sure the node is running with AA enabled:${NC}"
    echo -e "${YELLOW}    just run-node-aa${NC}"
    echo -e "${YELLOW}  Or:${NC}"
    echo -e "${YELLOW}    ./crates/client/account-abstraction/start_dev_node.sh${NC}"
    exit 1
fi
echo -e "${GREEN}‚úì Connected to node${NC}"
echo ""

# Test hash for getUserOperationByHash and getUserOperationReceipt
# Replace with a real hash after submitting a UserOperation
TEST_USER_OP_HASH="0x22d920df37a3aba75e21fb50ef1b20b11e27818c6c17d6be78073949863dea20"

# Test 1: eth_sendUserOperation (v0.6)
echo -e "${YELLOW}[1/8] Testing eth_sendUserOperation (v0.6)...${NC}"
curl -s -X POST $RPC_URL \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "eth_sendUserOperation",
    "params": [{
      "sender": "0x1234567890123456789012345678901234567890",
      "nonce": "0x1",
      "initCode": "0xabcd",
      "callData": "0x1234",
      "callGasLimit": "0x5208",
      "verificationGasLimit": "0x5208",
      "preVerificationGas": "0x5208",
      "maxFeePerGas": "0x3b9aca00",
      "maxPriorityFeePerGas": "0x3b9aca00",
      "paymasterAndData": "0x",
      "signature": "0x2fb6ef92acc71d3473225cfc5e58e8b95a06157e9fb3a8328c49aa8cf4a22bab27fc722fe20fa3dc84f0366506e0ee609ff67e10d3d66a85e129850932d0101c1c"
    }, "0x5FF137D4b0FDCD49DcA30c7CF57E578a026d2789"]
  }' | jq .
echo -e "${GREEN}‚úì Sent v0.6 UserOperation${NC}"
echo ""

# Test 2: eth_sendUserOperation (v0.7)
echo -e "${YELLOW}[2/8] Testing eth_sendUserOperation (v0.7)...${NC}"
curl -s -X POST $RPC_URL \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "id": 2,
    "method": "eth_sendUserOperation",
    "params": [{
      "sender": "0x1234567890123456789012345678901234567890",
      "nonce": "0x1",
      "callData": "0x1234",
      "callGasLimit": "0x5208",
      "verificationGasLimit": "0x5208",
      "preVerificationGas": "0x5208",
      "maxFeePerGas": "0x3b9aca00",
      "maxPriorityFeePerGas": "0x3b9aca00",
      "signature": "0x2fb6ef92acc71d3473225cfc5e58e8b95a06157e9fb3a8328c49aa8cf4a22bab27fc722fe20fa3dc84f0366506e0ee609ff67e10d3d66a85e129850932d0101c1c"
    }, "0x0000000071727De22E5E9d8BAf0edAc6f37da032"]
  }' | jq .
echo -e "${GREEN}‚úì Sent v0.7 UserOperation${NC}"
echo ""

# Test 3: eth_estimateUserOperationGas (v0.6) with state override
echo -e "${YELLOW}[3/8] Testing eth_estimateUserOperationGas (v0.6) with SimpleAccount state override...${NC}"

# SimpleAccount bytecode with v0.6 EntryPoint (0x5FF137D4b0FDCD49DcA30c7CF57E578a026d2789) immutable filled in
SIMPLE_ACCOUNT_BYTECODE="0x60806040526004361061012c5760003560e01c806352d1902d116100a5578063bc197c8111610074578063c4d66de811610059578063c4d66de8146103d0578063d087d288146103f0578063f23a6e611461040557600080fd5b8063bc197c8114610373578063c399ec88146103bb57600080fd5b806352d1902d146102b35780638da5cb5b146102c8578063b0d691fe14610320578063b61d27f61461035357600080fd5b80633659cfe6116100fc5780634a58db19116100e15780634a58db19146102785780634d44560d146102805780634f1ef286146102a057600080fd5b80633659cfe61461022a5780633a871cdd1461024a57600080fd5b806223de291461013857806301ffc9a71461015f578063150b7a021461019457806318dfb3c71461020a57600080fd5b3661013357005b600080fd5b34801561014457600080fd5b5061015d610153366004611c88565b5050505050505050565b005b34801561016b57600080fd5b5061017f61017a366004611d39565b61044b565b60405190151581526020015b60405180910390f35b3480156101a057600080fd5b506101d96101af366004611d7b565b7f150b7a020000000000000000000000000000000000000000000000000000000095945050505050565b6040517fffffffff00000000000000000000000000000000000000000000000000000000909116815260200161018b565b34801561021657600080fd5b5061015d610225366004611e33565b610530565b34801561023657600080fd5b5061015d610245366004611e9f565b61064a565b34801561025657600080fd5b5061026a610265366004611ebc565b61084f565b60405190815260200161018b565b61015d610875565b34801561028c57600080fd5b5061015d61029b366004611f10565b610914565b61015d6102ae366004611f6b565b6109cb565b3480156102bf57600080fd5b5061026a610bc1565b3480156102d457600080fd5b506000546102fb9062010000900473ffffffffffffffffffffffffffffffffffffffff1681565b60405173ffffffffffffffffffffffffffffffffffffffff909116815260200161018b565b34801561032c57600080fd5b507f0000000000000000000000005ff137d4b0fdcd49dca30c7cf57e578a026d27896102fb565b34801561035f57600080fd5b5061015d61036e36600461204d565b610cad565b34801561037f57600080fd5b506101d961038e36600461209d565b7fbc197c810000000000000000000000000000000000000000000000000000000098975050505050505050565b3480156103c757600080fd5b5061026a610cfc565b3480156103dc57600080fd5b5061015d6103eb366004611e9f565b610db3565b3480156103fc57600080fd5b5061026a610f46565b34801561041157600080fd5b506101d961042036600461213b565b7ff23a6e61000000000000000000000000000000000000000000000000000000009695505050505050565b60007fffffffff0000000000000000000000000000000000000000000000000000000082167f150b7a020000000000000000000000000000000000000000000000000000000014806104de57507fffffffff0000000000000000000000000000000000000000000000000000000082167f4e2312e000000000000000000000000000000000000000000000000000000000145b8061052a57507fffffffff0000000000000000000000000000000000000000000000000000000082167f01ffc9a700000000000000000000000000000000000000000000000000000000145b92915050565b610538610fc2565b8281146105a6576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601360248201527f77726f6e67206172726179206c656e677468730000000000000000000000000060448201526064015b60405180910390fd5b60005b838110156106435761063b8585838181106105c6576105c66121b7565b90506020020160208101906105db9190611e9f565b60008585858181106105ef576105ef6121b7565b905060200281019061060191906121e6565b8080601f01602080910402602001604051908101604052809392919081815260200183838082843760009201919091525061108b92505050565b6001016105a9565b5050505050565b73ffffffffffffffffffffffffffffffffffffffff7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc16300361070f576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602c60248201527f46756e6374696f6e206d7573742062652063616c6c6564207468726f7567682060448201527f64656c656761746563616c6c0000000000000000000000000000000000000000606482015260840161059d565b7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc73ffffffffffffffffffffffffffffffffffffffff166107847f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc5473ffffffffffffffffffffffffffffffffffffffff1690565b73ffffffffffffffffffffffffffffffffffffffff1614610827576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602c60248201527f46756e6374696f6e206d7573742062652063616c6c6564207468726f7567682060448201527f6163746976652070726f78790000000000000000000000000000000000000000606482015260840161059d565b61083081611108565b6040805160008082526020820190925261084c91839190611110565b50565b6000610859611314565b61086384846113b3565b905061086e8261146c565b9392505050565b7f0000000000000000000000005ff137d4b0fdcd49dca30c7cf57e578a026d27896040517fb760faf900000000000000000000000000000000000000000000000000000000815230600482015273ffffffffffffffffffffffffffffffffffffffff919091169063b760faf99034906024016000604051808303818588803b15801561090057600080fd5b505af1158015610643573d6000803e3d6000fd5b61091c6114d7565b7f0000000000000000000000005ff137d4b0fdcd49dca30c7cf57e578a026d27896040517f205c287800000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff848116600483015260248201849052919091169063205c287890604401600060405180830381600087803b1580156109af57600080fd5b505af11580156109c3573d6000803e3d6000fd5b505050505050565b73ffffffffffffffffffffffffffffffffffffffff7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc163003610a90576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602c60248201527f46756e6374696f6e206d7573742062652063616c6c6564207468726f7567682060448201527f64656c656761746563616c6c0000000000000000000000000000000000000000606482015260840161059d565b7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc73ffffffffffffffffffffffffffffffffffffffff16610b057f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc5473ffffffffffffffffffffffffffffffffffffffff1690565b73ffffffffffffffffffffffffffffffffffffffff1614610ba8576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602c60248201527f46756e6374696f6e206d7573742062652063616c6c6564207468726f7567682060448201527f6163746976652070726f78790000000000000000000000000000000000000000606482015260840161059d565b610bb182611108565b610bbd82826001611110565b5050565b60003073ffffffffffffffffffffffffffffffffffffffff7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc1614610c88576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152603860248201527f555550535570677261646561626c653a206d757374206e6f742062652063616c60448201527f6c6564207468726f7567682064656c656761746563616c6c0000000000000000606482015260840161059d565b507f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc90565b610cb5610fc2565b610cf6848484848080601f01602080910402602001604051908101604052809392919081815260200183838082843760009201919091525061108b92505050565b50505050565b6040517f70a0823100000000000000000000000000000000000000000000000000000000815230600482015260009073ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000005ff137d4b0fdcd49dca30c7cf57e578a026d278916906370a08231906024015b602060405180830381865afa158015610d8a573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610dae919061224b565b905090565b600054610100900460ff1615808015610dd35750600054600160ff909116105b80610ded5750303b158015610ded575060005460ff166001145b610e79576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602e60248201527f496e697469616c697a61626c653a20636f6e747261637420697320616c72656160448201527f647920696e697469616c697a6564000000000000000000000000000000000000606482015260840161059d565b600080547fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff001660011790558015610ed757600080547fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00ff166101001790555b610ee082611568565b8015610bbd57600080547fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00ff169055604051600181527f7f26b83ff96e1f2b6a682f133852f6798a09c465da95921460cefb38474024989060200160405180910390a15050565b6040517f35567e1a0000000000000000000000000000000000000000000000000000000081523060048201526000602482018190529073ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000005ff137d4b0fdcd49dca30c7cf57e578a026d278916906335567e1a90604401610d6d565b3373ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000005ff137d4b0fdcd49dca30c7cf57e578a026d2789161480611023575060005462010000900473ffffffffffffffffffffffffffffffffffffffff1633145b611089576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820181905260248201527f6163636f756e743a206e6f74204f776e6572206f7220456e747279506f696e74604482015260640161059d565b565b6000808473ffffffffffffffffffffffffffffffffffffffff1684846040516110b49190612288565b60006040518083038185875af1925050503d80600081146110f1576040519150601f19603f3d011682016040523d82523d6000602084013e6110f6565b606091505b50915091508161064357805160208201fd5b61084c6114d7565b7f4910fdfa16fed3260ed0e7147f7cc6da11a60208b5b9406d12a635614ffd91435460ff16156111485761114383611607565b505050565b8273ffffffffffffffffffffffffffffffffffffffff166352d1902d6040518163ffffffff1660e01b8152600401602060405180830381865afa9250505080156111cd575060408051601f3d9081017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe01682019092526111ca9181019061224b565b60015b611259576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602e60248201527f45524331393637557067726164653a206e657720696d706c656d656e7461746960448201527f6f6e206973206e6f742055555053000000000000000000000000000000000000606482015260840161059d565b7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc8114611308576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602960248201527f45524331393637557067726164653a20756e737570706f727465642070726f7860448201527f6961626c65555549440000000000000000000000000000000000000000000000606482015260840161059d565b50611143838383611711565b3373ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000005ff137d4b0fdcd49dca30c7cf57e578a026d27891614611089576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601c60248201527f6163636f756e743a206e6f742066726f6d20456e747279506f696e7400000000604482015260640161059d565b7f19457468657265756d205369676e6564204d6573736167653a0a3332000000006000908152601c829052603c81206114306113f36101408601866121e6565b8080601f01602080910402602001604051908101604052809392919081815260200183838082843760009201919091525085939250506117369050565b60005462010000900473ffffffffffffffffffffffffffffffffffffffff90811691161461146257600191505061052a565b5060009392505050565b801561084c5760405160009033907fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff90849084818181858888f193505050503d8060008114610643576040519150601f19603f3d011682016040523d82523d6000602084013e610643565b60005462010000900473ffffffffffffffffffffffffffffffffffffffff1633148061150257503330145b611089576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152600a60248201527f6f6e6c79206f776e657200000000000000000000000000000000000000000000604482015260640161059d565b600080547fffffffffffffffffffff0000000000000000000000000000000000000000ffff166201000073ffffffffffffffffffffffffffffffffffffffff8481168202929092178084556040519190048216927f0000000000000000000000005ff137d4b0fdcd49dca30c7cf57e578a026d2789909216917f47e55c76e7a6f1fd8996a1da8008c1ea29699cca35e7bcd057f2dec313b6e5de91a350565b73ffffffffffffffffffffffffffffffffffffffff81163b6116ab576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602d60248201527f455243313936373a206e657720696d706c656d656e746174696f6e206973206e60448201527f6f74206120636f6e747261637400000000000000000000000000000000000000606482015260840161059d565b7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc80547fffffffffffffffffffffffff00000000000000000000000000000000000000001673ffffffffffffffffffffffffffffffffffffffff92909216919091179055565b61171a8361175a565b6000825111806117275750805b1561114357610cf683836117a7565b600080600061174585856117cc565b9150915061175281611811565b509392505050565b61176381611607565b60405173ffffffffffffffffffffffffffffffffffffffff8216907fbc7cd75a20ee27fd9adebab32041f755214dbc6bffa90cc0225b39da2e5c2d3b90600090a250565b606061086e8383604051806060016040528060278152602001612325602791396119c4565b60008082516041036118025760208301516040840151606085015160001a6117f687828585611a49565b9450945050505061180a565b506000905060025b9250929050565b6000816004811115611825576118256122a4565b0361182d5750565b6001816004811115611841576118416122a4565b036118a8576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601860248201527f45434453413a20696e76616c6964207369676e61747572650000000000000000604482015260640161059d565b60028160048111156118bc576118bc6122a4565b03611923576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601f60248201527f45434453413a20696e76616c6964207369676e6174757265206c656e67746800604482015260640161059d565b6003816004811115611937576119376122a4565b0361084c576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602260248201527f45434453413a20696e76616c6964207369676e6174757265202773272076616c60448201527f7565000000000000000000000000000000000000000000000000000000000000606482015260840161059d565b60606000808573ffffffffffffffffffffffffffffffffffffffff16856040516119ee9190612288565b600060405180830381855af49150503d8060008114611a29576040519150601f19603f3d011682016040523d82523d6000602084013e611a2e565b606091505b5091509150611a3f86838387611b38565b9695505050505050565b6000807f7fffffffffffffffffffffffffffffff5d576e7357a4501ddfe92f46681b20a0831115611a805750600090506003611b2f565b6040805160008082526020820180845289905260ff881692820192909252606081018690526080810185905260019060a0016020604051602081039080840390855afa158015611ad4573d6000803e3d6000fd5b50506040517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0015191505073ffffffffffffffffffffffffffffffffffffffff8116611b2857600060019250925050611b2f565b9150600090505b94509492505050565b60608315611bce578251600003611bc75773ffffffffffffffffffffffffffffffffffffffff85163b611bc7576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601d60248201527f416464726573733a2063616c6c20746f206e6f6e2d636f6e7472616374000000604482015260640161059d565b5081611bd8565b611bd88383611be0565b949350505050565b815115611bf05781518083602001fd5b806040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161059d91906122d3565b73ffffffffffffffffffffffffffffffffffffffff8116811461084c57600080fd5b60008083601f840112611c5857600080fd5b50813567ffffffffffffffff811115611c7057600080fd5b60208301915083602082850101111561180a57600080fd5b60008060008060008060008060c0898b031215611ca457600080fd5b8835611caf81611c24565b97506020890135611cbf81611c24565b96506040890135611ccf81611c24565b955060608901359450608089013567ffffffffffffffff80821115611cf357600080fd5b611cff8c838d01611c46565b909650945060a08b0135915080821115611d1857600080fd5b50611d258b828c01611c46565b999c989b5096995094979396929594505050565b600060208284031215611d4b57600080fd5b81357fffffffff000000000000000000000000000000000000000000000000000000008116811461086e57600080fd5b600080600080600060808688031215611d9357600080fd5b8535611d9e81611c24565b94506020860135611dae81611c24565b935060408601359250606086013567ffffffffffffffff811115611dd157600080fd5b611ddd88828901611c46565b969995985093965092949392505050565b60008083601f840112611e0057600080fd5b50813567ffffffffffffffff811115611e1857600080fd5b6020830191508360208260051b850101111561180a57600080fd5b60008060008060408587031215611e4957600080fd5b843567ffffffffffffffff80821115611e6157600080fd5b611e6d88838901611dee565b90965094506020870135915080821115611e8657600080fd5b50611e9387828801611dee565b95989497509550505050565b600060208284031215611eb157600080fd5b813561086e81611c24565b600080600060608486031215611ed157600080fd5b833567ffffffffffffffff811115611ee857600080fd5b84016101608187031215611efb57600080fd5b95602085013595506040909401359392505050565b60008060408385031215611f2357600080fd5b8235611f2e81611c24565b946020939093013593505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b60008060408385031215611f7e57600080fd5b8235611f8981611c24565b9150602083013567ffffffffffffffff80821115611fa657600080fd5b818501915085601f830112611fba57600080fd5b813581811115611fcc57611fcc611f3c565b604051601f82017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0908116603f0116810190838211818310171561201257612012611f3c565b8160405282815288602084870101111561202b57600080fd5b8260208601602083013760006020848301015280955050505050509250929050565b6000806000806060858703121561206357600080fd5b843561206e81611c24565b935060208501359250604085013567ffffffffffffffff81111561209157600080fd5b611e9387828801611c46565b60008060008060008060008060a0898b0312156120b957600080fd5b88356120c481611c24565b975060208901356120d481611c24565b9650604089013567ffffffffffffffff808211156120f157600080fd5b6120fd8c838d01611dee565b909850965060608b013591508082111561211657600080fd5b6121228c838d01611dee565b909650945060808b0135915080821115611d1857600080fd5b60008060008060008060a0878903121561215457600080fd5b863561215f81611c24565b9550602087013561216f81611c24565b94506040870135935060608701359250608087013567ffffffffffffffff81111561219957600080fd5b6121a589828a01611c46565b979a9699509497509295939492505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b60008083357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe184360301811261221b57600080fd5b83018035915067ffffffffffffffff82111561223657600080fd5b60200191503681900382131561180a57600080fd5b60006020828403121561225d57600080fd5b5051919050565b60005b8381101561227f578181015183820152602001612267565b50506000910152565b6000825161229a818460208701612264565b9190910192915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602160045260246000fd5b60208152600082518060208401526122f2816040850160208701612264565b601f017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe016919091016040019291505056fe416464726573733a206c6f772d6c6576656c2064656c65676174652063616c6c206661696c6564a26469706673582212201f10445e6dffe7ddde21bf022413b2b37d385336ce4b3f30529cdeb68033a81164736f6c63430008170033"

# SimpleAccount v0.7 DEPLOYED bytecode with immutables filled in:
# - _entryPoint (ID 4267) = 0x0000000071727De22E5E9d8BAf0edAc6f37da032 (8 positions)
# - _self (ID 5610) = 0x1234567890123456789012345678901234567890 (3 positions) - must match sender address!
# NOTE: This bytecode is pre-patched. If you change the sender address, you must regenerate this bytecode.
SIMPLE_ACCOUNT_V07_BYTECODE="0x60806040526004361061010c575f3560e01c80638da5cb5b116100a1578063bc197c8111610071578063c4d66de811610057578063c4d66de8146103ad578063d087d288146103cc578063f23a6e61146103e0575f80fd5b8063bc197c8114610352578063c399ec8814610399575f80fd5b80638da5cb5b1461025c578063ad3cb1cc146102ac578063b0d691fe14610301578063b61d27f614610333575f80fd5b80634a58db19116100dc5780634a58db191461020e5780634d44560d146102165780634f1ef2861461023557806352d1902d14610248575f80fd5b806301ffc9a714610117578063150b7a021461014b57806319822f7c146101c057806347e1da2a146101ed575f80fd5b3661011357005b5f80fd5b348015610122575f80fd5b5061013661013136600461174a565b610425565b60405190151581526020015b60405180910390f35b348015610156575f80fd5b5061018f6101653660046117ef565b7f150b7a020000000000000000000000000000000000000000000000000000000095945050505050565b6040517fffffffff000000000000000000000000000000000000000000000000000000009091168152602001610142565b3480156101cb575f80fd5b506101df6101da36600461185d565b610509565b604051908152602001610142565b3480156101f8575f80fd5b5061020c6102073660046118ed565b61052e565b005b61020c6106d0565b348015610221575f80fd5b5061020c61023036600461198c565b610772565b61020c6102433660046119e3565b61081c565b348015610253575f80fd5b506101df61083b565b348015610267575f80fd5b505f546102879073ffffffffffffffffffffffffffffffffffffffff1681565b60405173ffffffffffffffffffffffffffffffffffffffff9091168152602001610142565b3480156102b7575f80fd5b506102f46040518060400160405280600581526020017f352e302e3000000000000000000000000000000000000000000000000000000081525081565b6040516101429190611ae6565b34801561030c575f80fd5b507f0000000000000000000000000000000071727de22e5e9d8baf0edac6f37da032610287565b34801561033e575f80fd5b5061020c61034d366004611b39565b610869565b34801561035d575f80fd5b5061018f61036c366004611b91565b7fbc197c810000000000000000000000000000000000000000000000000000000098975050505050505050565b3480156103a4575f80fd5b506101df6108b7565b3480156103b8575f80fd5b5061020c6103c7366004611c54565b61096b565b3480156103d7575f80fd5b506101df610ae8565b3480156103eb575f80fd5b5061018f6103fa366004611c6f565b7ff23a6e61000000000000000000000000000000000000000000000000000000009695505050505050565b5f7fffffffff0000000000000000000000000000000000000000000000000000000082167f150b7a020000000000000000000000000000000000000000000000000000000014806104b757507fffffffff0000000000000000000000000000000000000000000000000000000082167f4e2312e000000000000000000000000000000000000000000000000000000000145b8061050357507fffffffff0000000000000000000000000000000000000000000000000000000082167f01ffc9a700000000000000000000000000000000000000000000000000000000145b92915050565b5f610512610b63565b61051c8484610c04565b905061052782610cb4565b9392505050565b610536610d1c565b848114801561054c575082158061054c57508281145b6105b7576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601360248201527f77726f6e67206172726179206c656e677468730000000000000000000000000060448201526064015b60405180910390fd5b5f83900361065f575f5b85811015610659576106518787838181106105de576105de611cd4565b90506020020160208101906105f39190611c54565b5f85858581811061060657610606611cd4565b90506020028101906106189190611d01565b8080601f0160208091040260200160405190810160405280939291908181526020018383808284375f92019190915250610ddc92505050565b6001016105c1565b506106c8565b5f5b858110156106c6576106be87878381811061067e5761067e611cd4565b90506020020160208101906106939190611c54565b8686848181106106a5576106a5611cd4565b9050602002013585858581811061060657610606611cd4565b600101610661565b505b505050505050565b7f0000000000000000000000000000000071727de22e5e9d8baf0edac6f37da0326040517fb760faf900000000000000000000000000000000000000000000000000000000815230600482015273ffffffffffffffffffffffffffffffffffffffff919091169063b760faf99034906024015f604051808303818588803b158015610759575f80fd5b505af115801561076b573d5f803e3d5ffd5b5050505050565b61077a610e55565b7f0000000000000000000000000000000071727de22e5e9d8baf0edac6f37da0326040517f205c287800000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff848116600483015260248201849052919091169063205c2878906044015f604051808303815f87803b15801561080a575f80fd5b505af11580156106c8573d5f803e3d5ffd5b610824610edf565b61082d82610fe3565b6108378282610feb565b5050565b5f610844611129565b507f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc90565b610871610d1c565b6108b1848484848080601f0160208091040260200160405190810160405280939291908181526020018383808284375f92019190915250610ddc92505050565b50505050565b6040517f70a082310000000000000000000000000000000000000000000000000000000081523060048201525f9073ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000000000000071727de22e5e9d8baf0edac6f37da03216906370a08231906024015b602060405180830381865afa158015610942573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906109669190611d62565b905090565b7ff0c57e16840df040f15088dc2f81fe391c3923bec73e23a9662efc9c229c6a00805468010000000000000000810460ff16159067ffffffffffffffff165f811580156109b55750825b90505f8267ffffffffffffffff1660011480156109d15750303b155b9050811580156109df575080155b15610a16576040517ff92ee8a900000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b84547fffffffffffffffffffffffffffffffffffffffffffffffff00000000000000001660011785558315610a775784547fffffffffffffffffffffffffffffffffffffffffffffff00ffffffffffffffff16680100000000000000001785555b610a8086611198565b83156106c85784547fffffffffffffffffffffffffffffffffffffffffffffff00ffffffffffffffff168555604051600181527fc7f505b2f371ae2175ee4913f4499e1f2633a7b5936321eed1cdaeb6115181d29060200160405180910390a1505050505050565b6040517f35567e1a0000000000000000000000000000000000000000000000000000000081523060048201525f602482018190529073ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000000000000071727de22e5e9d8baf0edac6f37da03216906335567e1a90604401610927565b3373ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000000000000071727de22e5e9d8baf0edac6f37da0321614610c02576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601c60248201527f6163636f756e743a206e6f742066726f6d20456e747279506f696e740000000060448201526064016105ae565b565b7f19457468657265756d205369676e6564204d6573736167653a0a3332000000005f908152601c829052603c8120610c7d81610c44610100870187611d01565b8080601f0160208091040260200160405190810160405280939291908181526020018383808284375f9201919091525061122b92505050565b5f5473ffffffffffffffffffffffffffffffffffffffff908116911614610ca8576001915050610503565b505f9392505050565b50565b8015610cb1576040515f9033907fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff90849084818181858888f193505050503d805f811461076b576040519150601f19603f3d011682016040523d82523d5f602084013e61076b565b3373ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000000000000071727de22e5e9d8baf0edac6f37da032161480610d7657505f5473ffffffffffffffffffffffffffffffffffffffff1633145b610c02576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820181905260248201527f6163636f756e743a206e6f74204f776e6572206f7220456e747279506f696e7460448201526064016105ae565b5f808473ffffffffffffffffffffffffffffffffffffffff168484604051610e049190611d79565b5f6040518083038185875af1925050503d805f8114610e3e576040519150601f19603f3d011682016040523d82523d5f602084013e610e43565b606091505b50915091508161076b57805160208201fd5b5f5473ffffffffffffffffffffffffffffffffffffffff16331480610e7957503330145b610c02576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152600a60248201527f6f6e6c79206f776e65720000000000000000000000000000000000000000000060448201526064016105ae565b3073ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000001234567890123456789012345678901234567890161480610fac57507f000000000000000000000000123456789012345678901234567890123456789073ffffffffffffffffffffffffffffffffffffffff16610f937f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc5473ffffffffffffffffffffffffffffffffffffffff1690565b73ffffffffffffffffffffffffffffffffffffffff1614155b15610c02576040517fe07c8dba00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b610cb1610e55565b8173ffffffffffffffffffffffffffffffffffffffff166352d1902d6040518163ffffffff1660e01b8152600401602060405180830381865afa925050508015611070575060408051601f3d9081017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe016820190925261106d91810190611d62565b60015b6110be576040517f4c9c8ce300000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff831660048201526024016105ae565b7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc811461111a576040517faa1d49a4000000000000000000000000000000000000000000000000000000008152600481018290526024016105ae565b6111248383611253565b505050565b3073ffffffffffffffffffffffffffffffffffffffff7f00000000000000000000000012345678901234567890123456789012345678901614610c02576040517fe07c8dba00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b5f80547fffffffffffffffffffffffff00000000000000000000000000000000000000001673ffffffffffffffffffffffffffffffffffffffff838116918217835560405191927f0000000000000000000000000000000071727de22e5e9d8baf0edac6f37da032909116917f47e55c76e7a6f1fd8996a1da8008c1ea29699cca35e7bcd057f2dec313b6e5de9190a350565b5f805f8061123986866112b5565b92509250925061124982826112fe565b5090949350505050565b61125c82611401565b60405173ffffffffffffffffffffffffffffffffffffffff8316907fbc7cd75a20ee27fd9adebab32041f755214dbc6bffa90cc0225b39da2e5c2d3b905f90a28051156112ad5761112482826114cf565b61083761154e565b5f805f83516041036112ec576020840151604085015160608601515f1a6112de88828585611586565b9550955095505050506112f7565b505081515f91506002905b9250925092565b5f82600381111561131157611311611d8f565b0361131a575050565b600182600381111561132e5761132e611d8f565b03611365576040517ff645eedf00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b600282600381111561137957611379611d8f565b036113b3576040517ffce698f7000000000000000000000000000000000000000000000000000000008152600481018290526024016105ae565b60038260038111156113c7576113c7611d8f565b03610837576040517fd78bce0c000000000000000000000000000000000000000000000000000000008152600481018290526024016105ae565b8073ffffffffffffffffffffffffffffffffffffffff163b5f03611469576040517f4c9c8ce300000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff821660048201526024016105ae565b7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc80547fffffffffffffffffffffffff00000000000000000000000000000000000000001673ffffffffffffffffffffffffffffffffffffffff92909216919091179055565b60605f808473ffffffffffffffffffffffffffffffffffffffff16846040516114f89190611d79565b5f60405180830381855af49150503d805f8114611530576040519150601f19603f3d011682016040523d82523d5f602084013e611535565b606091505b5091509150611545858383611679565b95945050505050565b3415610c02576040517fb398979f00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b5f80807f7fffffffffffffffffffffffffffffff5d576e7357a4501ddfe92f46681b20a08411156115bf57505f9150600390508261166f565b604080515f808252602082018084528a905260ff891692820192909252606081018790526080810186905260019060a0016020604051602081039080840390855afa158015611610573d5f803e3d5ffd5b50506040517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0015191505073ffffffffffffffffffffffffffffffffffffffff811661166657505f92506001915082905061166f565b92505f91508190505b9450945094915050565b60608261168e5761168982611708565b610527565b81511580156116b2575073ffffffffffffffffffffffffffffffffffffffff84163b155b15611701576040517f9996b31500000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff851660048201526024016105ae565b5080610527565b8051156117185780518082602001fd5b6040517f1425ea4200000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b5f6020828403121561175a575f80fd5b81357fffffffff0000000000000000000000000000000000000000000000000000000081168114610527575f80fd5b73ffffffffffffffffffffffffffffffffffffffff81168114610cb1575f80fd5b5f8083601f8401126117ba575f80fd5b50813567ffffffffffffffff8111156117d1575f80fd5b6020830191508360208285010111156117e8575f80fd5b9250929050565b5f805f805f60808688031215611803575f80fd5b853561180e81611789565b9450602086013561181e81611789565b935060408601359250606086013567ffffffffffffffff811115611840575f80fd5b61184c888289016117aa565b969995985093965092949392505050565b5f805f6060848603121561186f575f80fd5b833567ffffffffffffffff811115611885575f80fd5b84016101208187031215611897575f80fd5b95602085013595506040909401359392505050565b5f8083601f8401126118bc575f80fd5b50813567ffffffffffffffff8111156118d3575f80fd5b6020830191508360208260051b85010111156117e8575f80fd5b5f805f805f8060608789031215611902575f80fd5b863567ffffffffffffffff811115611918575f80fd5b61192489828a016118ac565b909750955050602087013567ffffffffffffffff811115611943575f80fd5b61194f89828a016118ac565b909550935050604087013567ffffffffffffffff81111561196e575f80fd5b61197a89828a016118ac565b979a9699509497509295939492505050565b5f806040838503121561199d575f80fd5b82356119a881611789565b946020939093013593505050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b5f80604083850312156119f4575f80fd5b82356119ff81611789565b9150602083013567ffffffffffffffff811115611a1a575f80fd5b8301601f81018513611a2a575f80fd5b803567ffffffffffffffff811115611a4457611a446119b6565b6040517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0603f7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0601f8501160116810181811067ffffffffffffffff82111715611ab057611ab06119b6565b604052818152828201602001871015611ac7575f80fd5b816020840160208301375f602083830101528093505050509250929050565b602081525f82518060208401528060208501604085015e5f6040828501015260407fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0601f83011684010191505092915050565b5f805f8060608587031215611b4c575f80fd5b8435611b5781611789565b935060208501359250604085013567ffffffffffffffff811115611b79575f80fd5b611b85878288016117aa565b95989497509550505050565b5f805f805f805f8060a0898b031215611ba8575f80fd5b8835611bb381611789565b97506020890135611bc381611789565b9650604089013567ffffffffffffffff811115611bde575f80fd5b611bea8b828c016118ac565b909750955050606089013567ffffffffffffffff811115611c09575f80fd5b611c158b828c016118ac565b909550935050608089013567ffffffffffffffff811115611c34575f80fd5b611c408b828c016117aa565b999c989b5096995094979396929594505050565b5f60208284031215611c64575f80fd5b813561052781611789565b5f805f805f8060a08789031215611c84575f80fd5b8635611c8f81611789565b95506020870135611c9f81611789565b94506040870135935060608701359250608087013567ffffffffffffffff811115611cc8575f80fd5b61197a89828a016117aa565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52603260045260245ffd5b5f8083357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe1843603018112611d34575f80fd5b83018035915067ffffffffffffffff821115611d4e575f80fd5b6020019150368190038213156117e8575f80fd5b5f60208284031215611d72575f80fd5b5051919050565b5f82518060208501845e5f920191825250919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602160045260245ffdfea26469706673582212203f6c7930a1e2a5d7c05bebe217476e7f41c076d960525dad3bba3bb4ba5ce7ee64736f6c634300081a0033"

# SimpleAccount v0.8 DEPLOYED bytecode - same as v0.7 but with v0.8 EntryPoint address
# Generated by replacing 0000000071727de22e5e9d8baf0edac6f37da032 with 4337084d9e255ff0702461cf8895ce9e3b5ff108
SIMPLE_ACCOUNT_V08_BYTECODE=$(echo "$SIMPLE_ACCOUNT_V07_BYTECODE" | sed 's/0000000071727de22e5e9d8baf0edac6f37da032/4337084d9e255ff0702461cf8895ce9e3b5ff108/g')

# SimpleAccount v0.9 DEPLOYED bytecode - same as v0.7 but with v0.9 EntryPoint address
# Generated by replacing 0000000071727de22e5e9d8baf0edac6f37da032 with 433709009b8330fda32311df1c2afa402ed8d009
SIMPLE_ACCOUNT_V09_BYTECODE=$(echo "$SIMPLE_ACCOUNT_V07_BYTECODE" | sed 's/0000000071727de22e5e9d8baf0edac6f37da032/433709009b8330fda32311df1c2afa402ed8d009/g')

# Owner address for SimpleAccount (same as sender for simplicity)
# Storage slot 0 holds the owner (packed with initializer flag)
# The owner is stored at offset 2 bytes (after the initializer flags), so we need to pack it
# Slot 0 format: [unused 10 bytes][_initialized 1 byte][_initializing 1 byte][owner 20 bytes]
# For owner at 0x1234... and initialized = 1: 0x00000000000000000001001234567890123456789012345678901234567890
# Actually looking at OZ's Initializable + the owner storage: slot 0 = owner at bytes 2..21 (after init flags)
# Let's use: 0x0000000000000000000000011234567890123456789012345678901234567890
# Where the '01' at byte 10 is _initialized = true
OWNER_STORAGE="0x0000000000000000000000011234567890123456789012345678901234567890"

# callData: execute(address dest, uint256 value, bytes func) to send 0.001 ETH to 0x1111...
# selector: 0xb61d27f6
CALL_DATA="0xb61d27f6000000000000000000000000111111111111111111111111111111111111111100000000000000000000000000000000000000000000000000038d7ea4c6800000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000"

# 65-byte dummy signature (standard ECDSA length)
DUMMY_SIGNATURE="0x0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"

# EntryPoint deposit storage slot for sender 0x1234...
# Calculated as keccak256(abi.encode(sender, 0)) where 0 is the deposits mapping slot
ENTRYPOINT_DEPOSIT_SLOT="0x13425c139e83d895e2b184742e4c3c48f19def0307be60e6900f6563e300a60f"
# Deposit value: 10 ETH in the deposit field (DepositInfo struct)
ENTRYPOINT_DEPOSIT_VALUE="0x0000000000000000000000000000000000000000000000008ac7230489e80000"

curl -s -X POST $RPC_URL \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "id": 3,
    "method": "eth_estimateUserOperationGas",
    "params": [{
      "sender": "0x1234567890123456789012345678901234567890",
      "nonce": "0x0",
      "initCode": "0x",
      "callData": "'"$CALL_DATA"'",
      "callGasLimit": "0x0",
      "verificationGasLimit": "0x0",
      "preVerificationGas": "0x0",
      "maxFeePerGas": "0x3b9aca00",
      "maxPriorityFeePerGas": "0x3b9aca00",
      "paymasterAndData": "0x",
      "signature": "0x2fb6ef92acc71d3473225cfc5e58e8b95a06157e9fb3a8328c49aa8cf4a22bab27fc722fe20fa3dc84f0366506e0ee609ff67e10d3d66a85e129850932d0101c1c"
    }, 
    "0x5FF137D4b0FDCD49DcA30c7CF57E578a026d2789",
    {
      "0x1234567890123456789012345678901234567890": {
        "code": "'"$SIMPLE_ACCOUNT_BYTECODE"'",
        "balance": "0x8ac7230489e80000",
        "stateDiff": {
          "0x0000000000000000000000000000000000000000000000000000000000000000": "'"$OWNER_STORAGE"'"
        }
      },
      "0x5FF137D4b0FDCD49DcA30c7CF57E578a026d2789": {
        "stateDiff": {
          "'"$ENTRYPOINT_DEPOSIT_SLOT"'": "'"$ENTRYPOINT_DEPOSIT_VALUE"'"
        }
      }
    }]
  }' | jq .
echo -e "${GREEN}‚úì Estimated gas for v0.6 UserOperation with SimpleAccount state override${NC}"
echo ""

# Test 4: eth_estimateUserOperationGas (v0.7)
# Note: For v0.7, we omit factory/paymaster fields when they're not used (they default to zero address)
# This helps serde distinguish v0.7 from v0.6 since v0.7 lacks initCode/paymasterAndData
echo -e "${YELLOW}[4/8] Testing eth_estimateUserOperationGas (v0.7)...${NC}"
curl -s -X POST $RPC_URL \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "id": 4,
    "method": "eth_estimateUserOperationGas",
    "params": [{
      "sender": "0x1234567890123456789012345678901234567890",
      "nonce": "0x0",
      "factory": "0x0",
      "factoryData": "0x",
      "callData": "'"$CALL_DATA"'",
      "maxFeePerGas": "0x3b9aca00",
      "maxPriorityFeePerGas": "0x3b9aca00",
      "signature": "0x2fb6ef92acc71d3473225cfc5e58e8b95a06157e9fb3a8328c49aa8cf4a22bab27fc722fe20fa3dc84f0366506e0ee609ff67e10d3d66a85e129850932d0101c1c"
    }, "0x0000000071727De22E5E9d8BAf0edAc6f37da032",
    {
      "0x1234567890123456789012345678901234567890": {
        "code": "'"$SIMPLE_ACCOUNT_V07_BYTECODE"'",
        "balance": "0x8ac7230489e80000",
        "stateDiff": {
          "0x0000000000000000000000000000000000000000000000000000000000000000": "'"$OWNER_STORAGE"'"
        }
      },
      "0x0000000071727De22E5E9d8BAf0edAc6f37da032": {
        "stateDiff": {
          "'"$ENTRYPOINT_DEPOSIT_SLOT"'": "'"$ENTRYPOINT_DEPOSIT_VALUE"'"
        }
      }
    }]
  }' | jq .
echo -e "${GREEN}‚úì Estimated gas for v0.7 UserOperation${NC}"
echo ""

# Test 5: eth_estimateUserOperationGas (v0.8)
# v0.8 uses same UserOperation format as v0.7, but SimpleAccount needs v0.8 entrypoint
echo -e "${YELLOW}[5/10] Testing eth_estimateUserOperationGas (v0.8)...${NC}"
curl -s -X POST $RPC_URL \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "id": 5,
    "method": "eth_estimateUserOperationGas",
    "params": [{
      "sender": "0x1234567890123456789012345678901234567890",
      "nonce": "0x0",
      "factory": "0x0",
      "factoryData": "0x",
      "callData": "'"$CALL_DATA"'",
      "maxFeePerGas": "0x3b9aca00",
      "maxPriorityFeePerGas": "0x3b9aca00",
      "signature": "0x2fb6ef92acc71d3473225cfc5e58e8b95a06157e9fb3a8328c49aa8cf4a22bab27fc722fe20fa3dc84f0366506e0ee609ff67e10d3d66a85e129850932d0101c1c"
    }, "0x4337084D9e255Ff0702461CF8895CE9E3B5Ff108",
    {
      "0x1234567890123456789012345678901234567890": {
        "code": "'"$SIMPLE_ACCOUNT_V08_BYTECODE"'",
        "balance": "0x8ac7230489e80000",
        "stateDiff": {
          "0x0000000000000000000000000000000000000000000000000000000000000000": "'"$OWNER_STORAGE"'"
        }
      },
      "0x4337084D9e255Ff0702461CF8895CE9E3B5Ff108": {
        "stateDiff": {
          "'"$ENTRYPOINT_DEPOSIT_SLOT"'": "'"$ENTRYPOINT_DEPOSIT_VALUE"'"
        }
      }
    }]
  }' | jq .
echo -e "${GREEN}‚úì Estimated gas for v0.8 UserOperation${NC}"
echo ""

# Test 6: eth_estimateUserOperationGas (v0.9)
# v0.9 uses same UserOperation format as v0.7/v0.8, but SimpleAccount needs v0.9 entrypoint
echo -e "${YELLOW}[6/10] Testing eth_estimateUserOperationGas (v0.9)...${NC}"
curl -s -X POST $RPC_URL \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "id": 6,
    "method": "eth_estimateUserOperationGas",
    "params": [{
      "sender": "0x1234567890123456789012345678901234567890",
      "nonce": "0x0",
      "factory": "0x0",
      "factoryData": "0x",
      "callData": "'"$CALL_DATA"'",
      "maxFeePerGas": "0x3b9aca00",
      "maxPriorityFeePerGas": "0x3b9aca00",
      "signature": "0x2fb6ef92acc71d3473225cfc5e58e8b95a06157e9fb3a8328c49aa8cf4a22bab27fc722fe20fa3dc84f0366506e0ee609ff67e10d3d66a85e129850932d0101c1c"
    }, "0x433709009B8330FDa32311DF1C2AFA402eD8D009",
    {
      "0x1234567890123456789012345678901234567890": {
        "code": "'"$SIMPLE_ACCOUNT_V09_BYTECODE"'",
        "balance": "0x8ac7230489e80000",
        "stateDiff": {
          "0x0000000000000000000000000000000000000000000000000000000000000000": "'"$OWNER_STORAGE"'"
        }
      },
      "0x433709009B8330FDa32311DF1C2AFA402eD8D009": {
        "stateDiff": {
          "'"$ENTRYPOINT_DEPOSIT_SLOT"'": "'"$ENTRYPOINT_DEPOSIT_VALUE"'"
        }
      }
    }]
  }' | jq .
echo -e "${GREEN}‚úì Estimated gas for v0.9 UserOperation${NC}"
echo ""

# Test 7: eth_getUserOperationByHash
echo -e "${YELLOW}[7/10] Testing eth_getUserOperationByHash...${NC}"
curl -s -X POST $RPC_URL \
  -H "Content-Type: application/json" \
  -d "{
    \"jsonrpc\": \"2.0\",
    \"id\": 5,
    \"method\": \"eth_getUserOperationByHash\",
    \"params\": [\"$TEST_USER_OP_HASH\"]
  }" | jq .
echo -e "${GREEN}‚úì Queried UserOperation by hash${NC}"
echo ""

# Test 8: eth_getUserOperationReceipt
echo -e "${YELLOW}[8/10] Testing eth_getUserOperationReceipt...${NC}"
curl -s -X POST $RPC_URL \
  -H "Content-Type: application/json" \
  -d "{
    \"jsonrpc\": \"2.0\",
    \"id\": 6,
    \"method\": \"eth_getUserOperationReceipt\",
    \"params\": [\"$TEST_USER_OP_HASH\"]
  }" | jq .
echo -e "${GREEN}‚úì Queried UserOperation receipt${NC}"
echo ""

# Test 9: base_validateUserOperation (v0.6)
echo -e "${YELLOW}[9/10] Testing base_validateUserOperation (v0.6)...${NC}"
curl -s -X POST $RPC_URL \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "id": 5,
    "method": "base_validateUserOperation",
    "params": [{
      "sender": "0x1234567890123456789012345678901234567890",
      "nonce": "0x1",
      "initCode": "0xabcd",
      "callData": "0x1234",
      "callGasLimit": "0x5208",
      "verificationGasLimit": "0x5208",
      "preVerificationGas": "0x5208",
      "maxFeePerGas": "0x3b9aca00",
      "maxPriorityFeePerGas": "0x3b9aca00",
      "paymasterAndData": "0x",
      "signature": "0x2fb6ef92acc71d3473225cfc5e58e8b95a06157e9fb3a8328c49aa8cf4a22bab27fc722fe20fa3dc84f0366506e0ee609ff67e10d3d66a85e129850932d0101c1c"
    }, "0x5FF137D4b0FDCD49DcA30c7CF57E578a026d2789"]
  }' | jq .
echo -e "${GREEN}‚úì Validated v0.6 UserOperation${NC}"
echo ""

# Test 10: eth_supportedEntryPoints
echo -e "${YELLOW}[10/10] Testing eth_supportedEntryPoints...${NC}"
curl -s -X POST $RPC_URL \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "id": 6,
    "method": "eth_supportedEntryPoints",
    "params": []
  }' | jq .
echo -e "${GREEN}‚úì Retrieved supported EntryPoints${NC}"
echo ""

echo -e "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
echo -e "${GREEN}‚úÖ All tests completed!${NC}"
echo -e "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
echo ""
echo -e "${YELLOW}üí° Check your node logs to see the info!() messages${NC}"
echo -e "${YELLOW}   You should see logs for each UserOperation version detected${NC}"

