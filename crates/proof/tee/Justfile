set positional-arguments

eif_image_name := "op-enclave-rust-eif"
eif_output := "eif.bin"

# Default recipe to display help information
default:
    @just --list

# Build the Go enclave server
build-go-server:
    cd ../op-enclave/op-enclave && go build -o bin/enclave ./cmd/enclave

# Run integration tests (requires Go server to be running)
test-integration: build-go-server
    cargo test --package op-enclave-server --test go_interop -- --ignored --test-threads=1

# Run the enclave server locally (HTTP mode on port 1234)
run-server:
    RUST_LOG=info OP_ENCLAVE_SIGNER_KEY=ac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80 \
        cargo run --package base-prover --bin prover -- nitro

# Build EIF using Docker
build-eif:
    docker build -f Dockerfile.enclave -t {{ eif_image_name }} .
    docker create --name eif-extract {{ eif_image_name }}
    docker cp eif-extract:/build/eif.bin {{ eif_output }}
    docker rm eif-extract
    @echo "EIF built successfully: {{ eif_output }}"
    @ls -lh {{ eif_output }}

# Local musl release build (requires musl toolchain)
musl-release:
    OPENSSL_STATIC=1 cargo build --release --target x86_64-unknown-linux-musl --package base-prover --bin prover
    @echo "Binary built at: target/x86_64-unknown-linux-musl/release/prover"
    @ls -lh target/x86_64-unknown-linux-musl/release/prover

# Show PCR0 for built EIF (requires nitro-cli)
verify-pcr0:
    #!/usr/bin/env bash
    set -euo pipefail
    if [ -f "{{ eif_output }}" ]; then
        nitro-cli describe-eif --eif-path "{{ eif_output }}" | grep -A1 PCR0
    else
        echo "Error: {{ eif_output }} not found. Run 'just tee build-eif' first."
        exit 1
    fi

# Build twice and compare PCR0 for reproducibility verification
verify-reproducible:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "Building EIF first time..."
    just build-eif
    mv "{{ eif_output }}" eif-first.bin
    PCR0_FIRST=$(nitro-cli describe-eif --eif-path eif-first.bin 2>/dev/null | grep -A1 PCR0 | tail -1 | tr -d ' ",' || echo "nitro-cli not available")
    echo "First build PCR0: $PCR0_FIRST"
    echo ""
    echo "Building EIF second time..."
    just build-eif
    mv "{{ eif_output }}" eif-second.bin
    PCR0_SECOND=$(nitro-cli describe-eif --eif-path eif-second.bin 2>/dev/null | grep -A1 PCR0 | tail -1 | tr -d ' ",' || echo "nitro-cli not available")
    echo "Second build PCR0: $PCR0_SECOND"
    echo ""
    if command -v nitro-cli >/dev/null 2>&1; then
        PCR0_FIRST=$(nitro-cli describe-eif --eif-path eif-first.bin | grep -A1 PCR0 | tail -1 | tr -d ' ",')
        PCR0_SECOND=$(nitro-cli describe-eif --eif-path eif-second.bin | grep -A1 PCR0 | tail -1 | tr -d ' ",')
        if [ "$PCR0_FIRST" = "$PCR0_SECOND" ]; then
            echo "SUCCESS: PCR0 values match - build is reproducible!"
        else
            echo "FAILURE: PCR0 values differ - build is NOT reproducible"
            exit 1
        fi
    else
        echo "Comparing file hashes (nitro-cli not available)..."
        HASH1=$(sha256sum eif-first.bin | cut -d' ' -f1)
        HASH2=$(sha256sum eif-second.bin | cut -d' ' -f1)
        echo "First:  $HASH1"
        echo "Second: $HASH2"
        if [ "$HASH1" = "$HASH2" ]; then
            echo "SUCCESS: File hashes match!"
        else
            echo "WARNING: File hashes differ (may still have same PCR0)"
        fi
    fi
    rm -f eif-first.bin eif-second.bin

# Clean EIF artifacts
clean-eif:
    rm -f "{{ eif_output }}" eif-first.bin eif-second.bin
    docker rmi {{ eif_image_name }} 2>/dev/null || true
    @echo "EIF artifacts cleaned"
