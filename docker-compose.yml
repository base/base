services:
  # Setup genesis configs and devnet infrastructure
  setup:
    build:
      context: ./devnet
      dockerfile: Dockerfile.configs
    container_name: setup
    volumes:
      - ./.devnet/l1/configs:/output
    environment:
      - CHAIN_ID=1337
      - SLOT_DURATION=12
      - OUTPUT_DIR=/output
      - SHARED_DIR=/output

  # L1 Execution Layer (Reth)
  l1-el:
    image: ghcr.io/paradigmxyz/reth:v1.10.2
    container_name: l1-el
    depends_on:
      setup:
        condition: service_completed_successfully
    ports:
      - "4545:4545"   # HTTP RPC
      - "4546:4546"   # WebSocket
      - "4551:4551"   # Auth RPC (Engine API)
      - "4303:4303"   # P2P
    volumes:
      - ./.devnet/l1/reth:/data
      - ./.devnet/l1/configs:/genesis:ro
    entrypoint: /usr/local/bin/reth
    command:
      - node
      - --chain=/genesis/el/genesis.json
      - --datadir=/data
      - --color=never
      - --http
      - --http.addr=0.0.0.0
      - --http.port=4545
      - --http.api=admin,eth,web3,net,rpc,debug,txpool
      - --http.corsdomain=*
      - --ws
      - --ws.addr=0.0.0.0
      - --ws.port=4546
      - --ws.api=eth,web3,net,txpool,debug
      - --ws.origins=*
      - --authrpc.port=4551
      - --authrpc.addr=0.0.0.0
      - --authrpc.jwtsecret=/genesis/jwt.hex
      - --port=4303
      - --disable-discovery
      - -vvv
    healthcheck:
      test: ["CMD", "bash", "-c", "echo > /dev/tcp/localhost/4545"]
      interval: 1s
      timeout: 1s
      retries: 60
      start_period: 1s
    restart: unless-stopped

  # L1 Consensus Layer (Lighthouse beacon node)
  l1-cl:
    image: sigp/lighthouse:v8.0.1
    container_name: l1-cl
    depends_on:
      l1-el:
        condition: service_healthy
    ports:
      - "4052:4052"   # Beacon API
      - "4900:4900"   # P2P TCP
      - "4900:4900/udp" # P2P UDP
    volumes:
      - ./.devnet/l1/lighthouse:/data
      - ./.devnet/l1/configs:/genesis:ro
    command:
      - lighthouse
      - bn
      - --testnet-dir=/genesis/cl
      - --datadir=/data/beacon
      - --enable-private-discovery
      - --disable-peer-scoring
      - --staking
      - --enr-address=127.0.0.1
      - --enr-udp-port=4900
      - --enr-tcp-port=4900
      - --port=4900
      - --http
      - --http-address=0.0.0.0
      - --http-port=4052
      - --http-allow-origin=*
      - --disable-packet-filter
      - --target-peers=0
      - --supernode
      - --execution-endpoint=http://l1-el:4551
      - --execution-jwt=/genesis/jwt.hex
      - --always-prepare-payload
      - --prepare-payload-lookahead=8000
      - --suggested-fee-recipient=0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266
    healthcheck:
      test: ["CMD", "bash", "-c", "echo > /dev/tcp/localhost/4052"]
      interval: 1s
      timeout: 1s
      retries: 60
      start_period: 1s
    restart: unless-stopped

  # L1 Validator Client (Lighthouse)
  l1-vc:
    image: sigp/lighthouse:v8.0.1
    container_name: l1-vc
    depends_on:
      l1-cl:
        condition: service_healthy
    volumes:
      - ./.devnet/l1/configs:/genesis
    command:
      - lighthouse
      - vc
      - --testnet-dir=/genesis/cl
      - --datadir=/genesis/cl/validator_data
      - --beacon-nodes=http://l1-cl:4052
      - --init-slashing-protection
      - --suggested-fee-recipient=0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266
    restart: unless-stopped
